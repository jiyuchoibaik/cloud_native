# Nginx worker 프로세스 설정
worker_processes auto;

events {
  worker_connections 1024;
}

http {
  # MIME 타입 설정
  include /etc/nginx/mime.types;
  default_type application/octet-stream;
  resolver 127.0.0.11 valid=10s;


  # Docker Compose의 서비스 이름(컨테이너 이름)을 사용
  # 1. 프론트엔드 (React 앱)
   upstream frontend_service {
    # 'frontend'는 docker-compose.yml에 정의된 서비스 이름
    # React Dockerfile에서 80 포트를 EXPOSE 했음
    server frontend:80; 
  }

  # 2. 인증 서비스 (Node.js)
  upstream auth_service {
    # 'auth-service'는 docker-compose.yml에 정의된 서비스 이름
    server auth-service:3001; 
  }

  # 3. 일기 관리 서비스 (Node.js)
  upstream diary_service {
    server diary-service:3002;
  }


  # 메인 서버 블록 (HTTP: 80번 포트)
  server {
    listen 80;

    # (선택) 로깅 설정
    # access_log /var/log/nginx/access.log;
    # error_log /var/log/nginx/error.log;


    # 1. API - 인증 서비스 라우팅
    # http://localhost/api/auth/... 요청
    location /api/auth/ {
      proxy_pass http://auth_service/;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection 'upgrade';
      proxy_set_header Host $host;
      proxy_cache_bypass $http_upgrade;
    }

    # 2. API - 일기 관리 서비스 라우팅
    # http://localhost/api/diary/... 요청
    location /api/diary/ {
      proxy_pass http://diary_service/;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection 'upgrade';
      proxy_set_header Host $host;
      proxy_cache_bypass $http_upgrade;
    }
  
    # 3. 그 외 모든 요청 (React 앱으로 전달)
    # http://localhost/... (/, /mypage, /login 등)
    location / {
      proxy_pass http://frontend_service;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection 'upgrade';
      proxy_set_header Host $host;
      proxy_cache_bypass $http_upgrade;
    }
  }
}