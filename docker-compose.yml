# docker-compose.yml
# Docker Compose íŒŒì¼ (ë²„ì „ ëª…ì‹œëŠ” ì´ì œ ì„ íƒ ì‚¬í•­ì´ë©°, ìµœì‹  ë¬¸ë²•ìœ¼ë¡œ ì‘ì„±ë¨)

services:
  # 1. MongoDB (ë°ì´í„°ë² ì´ìŠ¤)
  mongodb:
    image: mongo:latest
    container_name: mongodb_container
    ports:
      - "27017:27017" # ë¡œì»¬ 27017 -> ì»¨í…Œì´ë„ˆ 27017
    volumes:
      - mongodb_data:/data/db # ì˜ì†ì ì¸ ë°ì´í„° ì €ì¥
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
    networks:
      - pet_diary_network
    restart: always

  # 2. Redis (ì„¸ì…˜ ê³µìœ  ë° ìºì‹œ)
  redis:
    image: redis:latest
    container_name: redis_container
    ports:
      - "6379:6379" # ë¡œì»¬ 6379 -> ì»¨í…Œì´ë„ˆ 6379
    command: redis-server --appendonly yes # ë°ì´í„° ì˜ì†ì„± í™œì„±í™”
    volumes:
      - redis_data:/data # ì˜ì†ì ì¸ ë°ì´í„° ì €ì¥
    networks:
      - pet_diary_network
    restart: always

  # 3. ì¸ì¦ ì„œë¹„ìŠ¤ (Node.js Express)
  auth-service:
    build:
      context: ./backend-auth
      dockerfile: Dockerfile
    container_name: auth_service_container
    ports:
      - "3001:3001" # ë¡œì»¬ 3001 -> ì»¨í…Œì´ë„ˆ 3001
    environment:
      PORT: 3001
      MONGO_URI: mongodb://mongodb:27017/auth_db # docker network ì´ë¦„ì„ ì‚¬ìš©
      MONGO_USERNAME: ${MONGO_USERNAME}
      MONGO_PASSWORD: ${MONGO_PASSWORD}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: 1h
    networks:
      - pet_diary_network
    depends_on:
      - mongodb
      - redis
    restart: always

  # 4. ì¼ê¸° ê´€ë¦¬ ì„œë¹„ìŠ¤ (Node.js Express)
  diary-service:
    build:
      context: ./backend-diary
      dockerfile: Dockerfile
    container_name: diary_service_container
    ports:
      - "3002:3002" # ë¡œì»¬ 3002 -> ì»¨í…Œì´ë„ˆ 3002
    environment:
      PORT: 3002
      MONGO_URI: mongodb://mongodb:27017/diary_db # docker network ì´ë¦„ì„ ì‚¬ìš©
      MONGO_USERNAME: ${MONGO_USERNAME}
      MONGO_PASSWORD: ${MONGO_PASSWORD}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      JWT_SECRET: ${JWT_SECRET} # â¬…ï¸ [ğŸŒŸ ì¤‘ìš”!] ì´ ì¤„ì„ ì¶”ê°€í•˜ì„¸ìš”.
      # AI_SERVICE_URL: http://ai-service:5000 # AI ì„œë¹„ìŠ¤ì™€ í†µì‹ ìš©
    networks:
      - pet_diary_network
    depends_on:
      - mongodb
      - redis
      - auth-service # ì¸ì¦ ì„œë¹„ìŠ¤ë¡œë¶€í„° JWT ê²€ì¦ í•„ìš”í•  ìˆ˜ ìˆìŒ
    restart: always

  # 5. AI ì„œë¹„ìŠ¤ (Python FastAPI)
  ai-service:
    build:
      context: ./ai-service
      dockerfile: Dockerfile
    container_name: ai_service_container
    ports:
      - "5001:5000" # ë¡œì»¬ 5000 -> ì»¨í…Œì´ë„ˆ 5000
    environment:
      PORT: 5000
      # CV_API_KEY: ${CV_API_KEY} # ì‹¤ì œ API í‚¤ëŠ” .envì—
      # HF_API_KEY: ${HF_API_KEY} # Hugging Face API í‚¤
    networks:
      - pet_diary_network
    # AI ì„œë¹„ìŠ¤ëŠ” DBë‚˜ Redisì— ì§ì ‘ ì˜ì¡´í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ
    # depends_on:
    #   - mongodb
    #   - redis
    restart: always

  # 6. í”„ë¡ íŠ¸ì—”ë“œ (React)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend_container
    environment:
      NODE_ENV: production # ìš´ì˜ í™˜ê²½ ë¹Œë“œ
      # REACT_APP_API_URL: http://localhost:80 # Nginxë¥¼ í†µí•´ ë°±ì—”ë“œ ì ‘ê·¼
    networks:
      - pet_diary_network
    #depends_on:
    #  - nginx # Nginx ë’¤ì— ìœ„ì¹˜í•˜ë¯€ë¡œ Nginxì— ì˜ì¡´

  # 7. Nginx (ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ)
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: nginx_container
    ports:
      - "80:80"   # HTTP
      - "443:443" # HTTPS (ì„ íƒ ì‚¬í•­)
    networks:
      - pet_diary_network
    depends_on:
      - frontend
      - auth-service
      - diary-service
      - ai-service
    restart: always

# Docker ë³¼ë¥¨ (ë°ì´í„° ì˜ì†ì„±)
volumes:
  mongodb_data:
  redis_data:

# Docker ë„¤íŠ¸ì›Œí¬ (ì„œë¹„ìŠ¤ ê°„ í†µì‹ )
networks:
  pet_diary_network:
    driver: bridge