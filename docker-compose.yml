# docker-compose.yml (수정된 전체 코드)

services:
  # 1. MongoDB (데이터베이스)
  mongodb:
    image: mongo:latest
    container_name: mongodb_container
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
    networks:
      - pet_diary_network
    restart: always

  # 2. Redis (세션 공유 및 캐시)
  redis:
    image: redis:latest
    container_name: redis_container
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - pet_diary_network
    restart: always

  # 3. 인증 서비스 (Node.js Express)
  auth-service:
    build:
      context: ./backend-auth
      dockerfile: Dockerfile
    container_name: auth_service_container
    ports:
      - "3001:3001"
    environment:
      PORT: 3001
      MONGO_URI: mongodb://mongodb:27017/auth_db
      MONGO_USERNAME: ${MONGO_USERNAME}
      MONGO_PASSWORD: ${MONGO_PASSWORD}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      JWT_SECRET: ${JWT_SECRET}
    networks:
      - pet_diary_network
    depends_on:
      - mongodb
      - redis
    restart: always

  # 4. 일기 관리 서비스 (Node.js Express)
  diary-service:
    build:
      context: ./backend-diary
      dockerfile: Dockerfile
    container_name: diary_service_container
    ports:
      - "3002:3002"
    environment:
      PORT: 3002
      MONGO_URI: mongodb://mongodb:27017/diary_db
      MONGO_USERNAME: ${MONGO_USERNAME}
      MONGO_PASSWORD: ${MONGO_PASSWORD}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      JWT_SECRET: ${JWT_SECRET}
      # AI_SERVICE_URL 환경 변수 제거
    networks:
      - pet_diary_network
    depends_on:
      - mongodb
      - redis
      - auth-service
      # ai-service 의존성 제거
    restart: always


  # 5. 프론트엔드 (React)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend_container
    # Nginx가 80번 포트를 사용하므로, 프론트엔드 포트는 외부에 노출하지 않습니다.
    networks:
      - pet_diary_network
    restart: always

  # 6. Nginx (리버스 프록시)
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: nginx_container
    ports:
      - "8080:80"
      - "443:443"
    networks:
      - pet_diary_network
    depends_on:
      - frontend
      - auth-service
      - diary-service
    restart: always 
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf

# Docker 볼륨
volumes:
  mongodb_data:
  redis_data:

# Docker 네트워크
networks:
  pet_diary_network:
    driver: bridge